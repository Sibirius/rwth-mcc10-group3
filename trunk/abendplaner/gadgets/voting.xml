<?xml version="1.0" encoding="UTF-8" ?> 
<Module>
<ModulePrefs title="Abendplaner Voting"
			 height="120"
			 scrolling="true">
  <Require feature="wave" /> 
</ModulePrefs>
<Content type="html">
<![CDATA[
	<body>	
	<script>
		//initialise global vars	
		var activities = ["","","",""]; //selected activities
		var active = ["eat","dance","drink","cinema"];
		  			
		function stateUpdated() {
  			//selected activities represented within one integer value
  			//like unix-file-permissions
  			//eat    <-> 2^3
  			//dance  <-> 2^2
  			//drink  <-> 2^1
  			//cinema <-> 2^0		
			var value = parseInt(wave.getState().get('value', '0'));
			for(var i = 0; i < 4; i++){
				if( Math.floor(value / Math.pow(2,3-i)) == 1 ){
					activities[i] = active[i];
				}
				value = value % Math.pow(2,4-i);
			}		
		    var params = {};  
		    params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.DOM;  
		    var url = "http://rwth-mcc10-group3.googlecode.com/svn/trunk/abendplaner/gadgets/locationdb.xml";  
		    gadgets.io.makeRequest(url, response, params);
		}
		
		function response(obj){
		    var domdata = obj.data;
			for(var i=0; i<activities.length; i++){
				if(activities[i]!=""){
					var h = document.createElement("h3");
					h.appendChild( document.createTextNode(activities[i]));
					insertNewChoice(h);
					var x=domdata.getElementsByTagName(activities[i])[0].getElementsByTagName("location");			        
			        for (j=0;j<x.length;j++){	
						insertNewChoice( createVoteElement( x[j].getElementsByTagName("name")[0].childNodes[0].nodeValue, j) );
					}		    
				}
	    	}		
		}
		
		// creates element with label and yes/no choice
		function createVoteElement(text, number) {
			var p = document.createElement("p");
		
			var select = document.createElement("select");
	
			var ja = document.createElement("option");
			ja.appendChild(document.createTextNode("yes"));
			var nein = document.createElement("option");
			nein.appendChild(document.createTextNode("nein"));

			select.appendChild(ja);
			select.appendChild(nein);			

			p.appendChild(document.createTextNode(text));
			p.appendChild(select);

			return p;
		}
				
		// inserts before button after all the other choices
		function insertNewChoice(choice) {
			var vc = document.getElementById("voting_container");
			var vb = document.getElementById("voting_btn");

			vc.insertBefore(choice, vb); 
			 
		}
		
	    function init() {
	      if (wave && wave.isInWaveContainer()) {
	        wave.setStateCallback(stateUpdated);
	      }
	    }
	    
	    gadgets.util.registerOnLoadHandler(init);	
	</script>
	<form action="javascript:return;" id="voting_container">
		<input id="voting_btn" type="button" value="Vote!" onclick="init()"/>
	</form>
  ]]> 
  </Content>
</Module>